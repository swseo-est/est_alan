# 테스트 코드 작성 가이드

## 목차
1. [개요](#개요)
2. [테스트 구조 및 네이밍 컨벤션](#테스트-구조-및-네이밍-컨벤션)
3. [Fixture 사용법](#fixture-사용법)
4. [Mock 사용법](#mock-사용법)
5. [비동기 테스트](#비동기-테스트)
6. [LLM 테스트 가이드](#llm-테스트-가이드)
7. [테스트 카테고리별 가이드](#테스트-카테고리별-가이드)
8. [모범 사례](#모범-사례)
9. [주의사항](#주의사항)

## 개요

이 문서는 EST Alan 프로젝트의 테스트 코드 작성 가이드입니다. 기존 테스트 코드를 분석하여 일관성 있는 테스트 작성 방법을 제시합니다.

### 테스트 목표
- 코드의 정확성 검증
- 리팩토링 시 안전성 보장
- 문서화 역할
- 버그 조기 발견

## 테스트 구조 및 네이밍 컨벤션

### 디렉토리 구조 (1:1 매칭)

테스트 폴더 구조는 `estalan` 폴더와 1:1로 매칭되어야 합니다:

```
src/
├── estalan/                    # 소스 코드
│   ├── agent/
│   │   ├── base/
│   │   ├── graph/
│   │   └── langgraph/
│   ├── llm/
│   ├── messages/
│   ├── deployment/
│   ├── tools/
│   └── ...
└── tests/
    └── test_estalan/           # 테스트 코드 (1:1 매칭)
        ├── test_agent/
        │   ├── test_base/
        │   │   ├── test_state.py
        │   │   ├── test_node.py
        │   │   └── test_reducer_function.py
        │   ├── test_graph/
        │   │   ├── test_browser_use_agent/
        │   │   ├── test_requirement_collection_agent/
        │   │   └── test_slide_generate_agent/
        │   └── test_langgraph/
        │       ├── test_react_agent.py
        │       └── test_supervisor_agent.py
        ├── test_llm/
        │   ├── test_base.py
        │   ├── test_estalan_anthropic.py
        │   ├── test_estalan_openai.py
        │   ├── test_estalan_google_vertexai.py
        │   ├── test_lg_exaone.py
        │   └── test_llm_utils.py
        ├── test_messages/
        │   ├── test_base.py
        │   ├── test_utils.py
        │   └── test_format/
        │       └── test_chat_html.py
        ├── test_deployment/
        │   ├── test_cli.py
        │   ├── test_server.py
        │   └── test_webhook.py
        ├── test_tools/
        │   ├── test_base.py
        │   ├── test_mcp/
        │   ├── test_search.py
        │   └── test_utils.py
        └── test_core/
            ├── test_agent.py
            ├── test_llm.py
            └── test_node.py
```

### 파일 네이밍 규칙
- 테스트 파일명: `test_<모듈명>.py`
- 테스트 함수명: `test_<기능명>_<시나리오>`
- 테스트 클래스명: `Test<클래스명>`

### 함수 네이밍 예시
```python
def test_alan_agent_metadata_default_values():
    """AlanAgentMetaData의 기본값이 올바르게 설정되는지 테스트"""

def test_create_alan_agent_start_node_sets_chat_status_unavailable():
    """create_alan_agent_start_node가 chat_status를 'unavailable'로 설정하는지 테스트"""

def test_convert_aimessage_to_alan():
    """Test converting AIMessage to AlanAIMessage."""
```

## 비동기 테스트

### 비동기 테스트 작성법
```python
@pytest.mark.asyncio
async def test_ainvoke_success():
    """ainvoke 함수 테스트: 성공 케이스"""
    # estalan.llm.utils의 create_chat_model 함수 사용
    from estalan.llm.utils import create_chat_model
    import os
    
    api_key = os.getenv("ANTHROPIC_API_KEY")
    if not api_key:
        pytest.skip("ANTHROPIC_API_KEY 환경변수가 설정되지 않았습니다")
    
    model = create_chat_model(provider="anthropic", model="claude-3-sonnet-20240229")
    
    result = await model.ainvoke("안녕하세요")
    
    assert result is not None
    assert isinstance(result, str)
    assert len(result) > 0

@pytest.mark.asyncio
async def test_async_function_with_error():
    """비동기 함수 에러 처리 테스트"""
    # 잘못된 provider로 에러 발생
    from estalan.llm.utils import create_chat_model
    
    with pytest.raises(Exception, match="Unsupported provider"):
        model = create_chat_model(provider="invalid_provider", model="test")
        await model.ainvoke("test")

@pytest.mark.asyncio
async def test_async_function_with_timeout():
    """비동기 함수 타임아웃 테스트"""
    import asyncio
    from estalan.llm.utils import create_chat_model
    
    # 정상적인 모델 생성
    api_key = os.getenv("ANTHROPIC_API_KEY")
    if not api_key:
        pytest.skip("ANTHROPIC_API_KEY 환경변수가 설정되지 않았습니다")
    
    model = create_chat_model(provider="anthropic", model="claude-3-sonnet-20240229")
    
    # 타임아웃 설정 (1초) - 실제로는 빠르게 응답하므로 타임아웃이 발생하지 않음
    result = await asyncio.wait_for(model.ainvoke("안녕하세요"), timeout=30.0)
    
    assert result is not None
    assert isinstance(result, str)
```


## LLM 테스트 가이드

### LLM 모델별 테스트 작성법

LLM을 사용하는 기능을 테스트할 때는 `estalan/llm/` 폴더에 정의된 모든 모델을 사용하여 테스트해야 합니다.

#### 1. 모든 LLM 모델 테스트
```python
import pytest
import os
from estalan.llm.utils import create_chat_model

# 실제 LLM 모델 Fixture들 (환경변수 설정 필요)
@pytest.fixture
def anthropic_model():
    """Anthropic 모델 실제 인스턴스"""
    # 환경변수에서 API 키 가져오기
    api_key = os.getenv("ANTHROPIC_API_KEY")
    if not api_key:
        pytest.skip("ANTHROPIC_API_KEY 환경변수가 설정되지 않았습니다")
    
    # estalan.llm.utils의 create_chat_model 함수 사용
    return create_chat_model(provider="anthropic", model="claude-3-sonnet-20240229")

@pytest.fixture
def openai_model():
    """OpenAI 모델 실제 인스턴스"""
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        pytest.skip("OPENAI_API_KEY 환경변수가 설정되지 않았습니다")
    
    # estalan.llm.utils의 create_chat_model 함수 사용
    return create_chat_model(provider="openai", model="gpt-4")

@pytest.fixture
def vertexai_model():
    """Google VertexAI 모델 실제 인스턴스"""
    project_id = os.getenv("GOOGLE_CLOUD_PROJECT")
    if not project_id:
        pytest.skip("GOOGLE_CLOUD_PROJECT 환경변수가 설정되지 않았습니다")
    
    # estalan.llm.utils의 create_chat_model 함수 사용
    return create_chat_model(provider="google_vertexai", model="gemini-2.0-flash")

@pytest.fixture
def azure_openai_model():
    """Azure OpenAI 모델 실제 인스턴스"""
    azure_endpoint = os.getenv("AZURE_ENDPOINT")
    if not azure_endpoint:
        pytest.skip("AZURE_ENDPOINT 환경변수가 설정되지 않았습니다")
    
    # estalan.llm.utils의 create_chat_model 함수 사용
    return create_chat_model(provider="azure_openai", model="gpt-4")

@pytest.mark.asyncio
async def test_all_llm_models_response(anthropic_model, openai_model, vertexai_model, azure_openai_model):
    """모든 LLM 모델이 응답을 생성하는지 테스트"""
    test_input = "안녕하세요. 간단한 인사말을 해주세요."
    
    # 모든 모델 테스트
    models = [anthropic_model, openai_model, vertexai_model, azure_openai_model]
    
    for model in models:
        result = await model.ainvoke(test_input)
        assert result is not None
        assert isinstance(result, str)
        assert len(result) > 0
        print(f"모델 {type(model).__name__} 응답: {result[:100]}...")

@pytest.mark.asyncio
async def test_llm_error_handling():
    """LLM 모델의 에러 처리 테스트"""
    # 잘못된 설정으로 테스트
    try:
        # 잘못된 provider로 모델 생성 시도
        invalid_model = create_chat_model(provider="invalid_provider", model="test")
        await invalid_model.ainvoke("test")
    except Exception as e:
        assert "Unsupported provider" in str(e)
```

### LLM 테스트 작성 시 주의사항

1. **모든 모델 커버**: `estalan/llm/` 폴더의 모든 모델을 테스트에 포함
2. **utils 함수 사용**: `estalan.llm.utils.create_chat_model` 함수를 사용하여 모델 생성
3. **실제 API 사용**: 실제 LLM API를 호출하여 통합 테스트 수행
4. **에러 시나리오**: 각 모델별 에러 처리 로직 테스트
5. **비동기 처리**: `@pytest.mark.asyncio` 데코레이터 사용
6. **재시도 로직**: 네트워크 오류 시 재시도 로직 검증 (내장되어 있음)
7. **환경변수 설정**: API 키를 환경변수로 관리하여 보안 유지
8. **테스트 격리**: 각 테스트가 독립적으로 실행되도록 설계


## 주의사항

### 1. 테스트 격리
- 각 테스트는 독립적으로 실행될 수 있어야 함
- 테스트 간 상태 공유 금지
- Fixture를 활용하여 테스트 데이터 관리

### 2. 테스트 실행 시간
- 단위 테스트는 빠르게 실행되어야 함
- 통합 테스트는 별도로 관리
- 비동기 테스트에서 적절한 타임아웃 설정

### 3. 실제 API 사용 시 주의사항
- API 키를 환경변수로 관리하여 보안 유지
- API 호출 제한과 비용을 고려한 테스트 설계
- 네트워크 오류에 대한 적절한 처리

### 4. 테스트 커버리지
- 핵심 기능에 대한 테스트 우선
- 경계값 테스트 포함
- 예외 상황 테스트 포함

### 5. 한글 주석 사용
- 모든 주석은 한글로 작성
- 테스트 목적과 시나리오를 명확히 설명
- 복잡한 로직에 대한 상세한 설명 추가


## 테스트 디버깅 팁

### 1. 테스트 실패 시 확인사항
```python
# 상세한 에러 메시지 출력
def test_with_detailed_assertion():
    result = function_under_test()
    assert result == expected_value, f"Expected {expected_value}, but got {result}"
```

### 2. 테스트 데이터 검증
```python
def test_with_data_validation():
    # 테스트 데이터 준비
    test_data = prepare_test_data()
    
    # 데이터 유효성 검증
    assert test_data is not None, "테스트 데이터가 None입니다"
    assert len(test_data) > 0, "테스트 데이터가 비어있습니다"
    
    # 실제 테스트
    result = function_under_test(test_data)
    assert result is not None
```

### 3. 실제 함수 호출 검증
```python
def test_actual_function_calls():
    # 실제 함수 호출 테스트
    result = function_under_test()
    
    # 결과 검증
    assert result is not None, "함수가 None을 반환했습니다"
    assert isinstance(result, str), f"예상된 타입이 아닙니다. got: {type(result)}"
    assert len(result) > 0, "빈 결과가 반환되었습니다"
```

## 테스트 실행 방법

### 전체 테스트 실행
```bash
pytest src/tests/
```

### 특정 모듈 테스트
```bash
pytest src/tests/test_estalan/test_llm/
```

### 특정 테스트 파일 실행
```bash
pytest src/tests/test_estalan/test_llm/test_base.py
```

### 특정 테스트 함수 실행
```bash
pytest src/tests/test_estalan/test_llm/test_base.py::test_init_default_name
```

### 테스트 커버리지 확인
```bash
pytest --cov=estalan src/tests/
```

이 가이드를 따라 일관성 있고 유지보수 가능한 테스트 코드를 작성하시기 바랍니다.

## 참고 자료

### 프로젝트 내 테스트 예시
- **상태 관리 테스트**: `src/tests/test_estalan/test_agent/test_base/test_state.py`
- **노드 테스트**: `src/tests/test_estalan/test_agent/test_base/test_node.py`
- **Reducer 함수 테스트**: `src/tests/test_estalan/test_agent/test_base/test_reducer_function.py`
- **LLM 통합 테스트**: `src/tests/test_estalan/test_llm/test_base.py`
- **LLM 모델별 테스트**: 
  - `src/tests/test_estalan/test_llm/test_estalan_anthropic.py`
  - `src/tests/test_estalan/test_llm/test_estalan_openai.py`
  - `src/tests/test_estalan/test_llm/test_estalan_google_vertexai.py`
  - `src/tests/test_estalan/test_llm/test_lg_exaone.py`
- **메시지 변환 테스트**: `src/tests/test_estalan/test_messages/test_base.py`
- **CLI 통합 테스트**: `src/tests/test_estalan/test_deployment/test_cli.py`
- **포맷 유틸리티 테스트**: `src/tests/test_estalan/test_messages/test_format/test_chat_html.py`

### 외부 참고 자료
- [pytest 공식 문서](https://docs.pytest.org/)
- [unittest.mock 공식 문서](https://docs.python.org/3/library/unittest.mock.html)
- [Python Testing with pytest](https://pytest.org/en/stable/)

### 프로젝트 특화 가이드
- LangGraph 기반 에이전트 테스트 작성법
- 비동기 함수 테스트 패턴
- Mock을 활용한 외부 의존성 격리
- 통합 테스트에서의 서버 시작/종료 관리

---

**작성자**: EST Alan 개발팀  
**최종 업데이트**: 2024년  
**버전**: 1.0
